---
- name: Create a new Demo EC2 instance
  hosts: localhost
  gather_facts: False

  vars:
      keypair: polygot # pem file name
      vpc_name: ployglot-test
      vpc_cidr_block: 10.0.0.0/16
      aws_region: ap-south-1
      public_subnet_1_cidr: 10.0.0.0/24
      private_subnet_1_cidr: "10.0.1.0/24"
      ami: ami-3c374c53
      instance_type: t2.micro
      
  tasks:
       - name: create VPC
         ec2_vpc_net:
                name:             "{{ vpc_name }}"
                cidr_block:       "{{ vpc_cidr_block }}"
                region:           "{{ aws_region }}"
                state:            "present"
         register: my_vpc

       - name:  Set VPC ID in variable
         set_fact:
                vpc_id: "{{ my_vpc.vpc.id }}"

       - name: Create Public Subnet
         ec2_vpc_subnet:
           state:            "present"
           vpc_id:           "{{ vpc_id }}"
           cidr:             "{{ public_subnet_1_cidr }}"
           az:               "{{ aws_region }}a"
           region:           "{{ aws_region }}"
           resource_tags:
                Name:           "Public Subnet"
         register: my_public_subnet

       - name: Set Public Subnet ID in variable
         set_fact:
                public_subnet_id: "{{ my_public_subnet.subnet.id }}"

       - name: Create Private Subnet
         ec2_vpc_subnet:
           state: "present"
           vpc_id: "{{ vpc_id }}"
           cidr: "{{ private_subnet_1_cidr }}"
           az: "{{ aws_region }}a"
           region: "{{ aws_region }}"
           resource_tags:
                Name: "Private Subnet"
         register:  my_private_subnet

       - name: Create Internet Gateway for VPC
         ec2_vpc_igw:
           vpc_id: "{{ vpc_id }}"
           region: "{{ aws_region }}"
           state: "present"
         register: my_vpc_igw

       - name: Set Internet Gateway ID in variable
         set_fact:
           igw_id: "{{ my_vpc_igw.gateway_id }}"

       - name: Set up public subnet route table
         ec2_vpc_route_table:
           vpc_id: "{{ vpc_id }}"
           region: "{{ aws_region }}"
           routes:
                 - dest: 0.0.0.0/0
                   gateway_id: "{{ igw_id }}"
         register: public_route_table

       - name: Create an ec2 instance
         ec2:
            key_name: "{{ keypair }}"
            group: default
            instance_type: "{{ instance_type }}"
            image: "{{ ami }}"
            wait: true
            region: "{{ aws_region }}"
            count: 1  # default
            count_tag:
               Name: Demo
            instance_tags:
               Name: Demo
            vpc_subnet_id: "{{ my_private_subnet.subnet.id }}"#subnet-68bb4f00
            assign_public_ip: yes
         register: ec2
